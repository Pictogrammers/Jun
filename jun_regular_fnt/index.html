<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preview</title>
    <style>
        :root {
            --app-font: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --app-color: #E0E0E0;
        }
        body {
            display: grid;
            grid-template-columns: auto 1fr;
            grid-template-rows: auto;
            background: #262626;
            margin: 0;
            font-family: var(--app-font);
            height: 100vh;
        }
        div.tree {
            display: grid;
            grid-column: 1;
            grid-row: 1;
            background: #3D3D3D;
            color: #DFDFDF;
            padding: 0.5rem;
            width: 12rem;
        }
        div.tree > ul {
            margin: 0;
            padding: 0;
            list-style: none;
            display: grid;
            grid-template-columns: auto;
            grid-template-rows: auto auto auto auto 1fr;
        }
        div.tree > ul > li > div {
            padding: 0 0.5rem;
        }
        div.tree > ul > li ul {
            background: #2B2B2B;
            border-radius: 0.25rem;
            padding: 0.125rem;
            margin: 0.25rem 0;
            font-size: 0.875rem;
            list-style: none;
        }
        div.tree > ul > li ul > li > button {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 0;
            background: transparent;
            font: var(--app-font);
            color: var(--app-color);
            border-radius: 0.125rem;
            text-align: left;
        }
        div.tree > ul > li ul > li > button:hover {
            background: #495958;
        }
        div.tree > ul > li ul > li > button.selected {
            background: #495958;
        }
        li.version {
            align-content: end;
            text-align: center;
            color: #AAA;
        }
        div.main {
            grid-column: 2;
            grid-row: 1;
            display: grid;
            grid-template-columns: auto 1fr;
            grid-template-rows: auto;
            grid-gap: 0.5rem 2rem;
            overflow: auto;
            padding: 1rem;
            background: #FFF;;
        }
        div.page {
            grid-column: 1;
            grid-row: 1;
            align-items: flex-start;
            justify-content: flex-start;
            display: inline-flex;
            position: relative;
            background: #FFF;
            box-shadow: 0 0 1rem rgba(0, 0, 0, 0.25);
        }
        div.page > img {
            image-rendering: pixelated;
        }
        div.page > div {
            position: absolute;
            background: rgba(255, 0, 0, 0.3);
            box-sizing: border-box;
        }
        div.page > div:hover {
            background: rgba(33, 150, 243, 0.3);
        }
        div.preview {
            grid-column: 1;
            grid-row: 4;
            display: flex;
            background: #FFF;
            box-shadow: 0 0 1rem rgba(0, 0, 0, 0.25);
        }
        canvas {
            image-rendering: pixelated;
        }
        canvas.hover {
            background: #c6ebff;
        }
        canvas.hover-exists {
            background: #8de558;;
        }
        div.preview > canvas:first-child {
            margin-left: 0 !important;
        }
        p {
            grid-column: 1;
            grid-row: 2;
            color: #666;
            margin: 0 0.5rem 1rem 0.5rem;
        }
        textarea {
            grid-column: 1;
            grid-row: 3;
            border: 1px solid #111;
            border-radius: 0.25rem;
            resize: none;
            width: 20rem;
            height: 3rem;
            padding: 0.5rem;
        }
        table {
            grid-column: 2;
            grid-row: 1 / 6;
            border-spacing: 0;
            max-width: 15rem;
        }
        table th {
            padding-right: 0.5rem;
            font-size: 0.875rem;
        }
        table tr:nth-child(odd) {
            background-color: #EEE;
        }
        table tr:nth-child(1) {
            background-color: #FFF;
        }
        table tr:nth-child(1) th {
            border-bottom: 1px solid #DDD;
            text-align: left;
        }
        /**
         * Toast
         */
        .toast {
            position: absolute;
            padding: 0.75rem 1rem;
            background: #EEE;
            top: 1rem;
            right: 1rem;
            box-shadow: 0 0.25rem 1rem rgba(0, 0, 0, 0.25);
            border-radius: 0.5rem;
        }
        .toast-info {
            color: #fff;
            font-weight: 500;
            background-color: #2196f3;
        }
        .toast-warning {
            color: #fff;
            font-weight: 500;
            background-color: #ff9800;
        }
        .toast-error {
            color: #fff;
            font-weight: 500;
            background-color: #f44336;
        }
        .toast-success {
            color: #fff;
            font-weight: 500;
            background-color: #4caf50;
        }
        /**
         * Info / Common
         */
        ul.common,
        ul.info {
            display: flex;
            gap: 0.125rem;
            flex-direction: column;
        }
        li.row {
            display: flex;
            flex-direction: row;
            gap: 0.125rem;
        }
        li.row div {
            padding: 0.125rem 0.5rem;
            background: #3D3D3D;
        }
        li.row div:first-child {
            background: rgba(61, 61, 61, 0.5);
            border-top-left-radius: 0.125rem;
            border-bottom-left-radius: 0.125rem;
            color: #BBB;
        }
        li.row div:last-child {
            border-top-right-radius: 0.125rem;
            border-bottom-right-radius: 0.125rem;
            padding: 0.125rem 0.5rem;
        }
    </style>
    <script>
        // Cache Configs
        const characters = new Map();
        const pages = new Map();
        const imagePages = new Map();
        const info = new Map();
        const kernings = new Map();
        // Utilities
        function addPage(name) {
            const pagesElement = document.getElementById('pages');
            const item = document.createElement('li');
            const button = document.createElement('button');
            button.textContent = name;
            item.appendChild(button);
            pagesElement.appendChild(item);
        }
        function addInfo(label, value, title) {
            const row = document.createElement('li');
            row.classList.add('row');
            const labelEle = document.createElement('div');
            labelEle.textContent = label;
            labelEle.title = title;
            row.appendChild(labelEle);
            if (value instanceof Array) {
                value.forEach(item => {
                    const valueEle = document.createElement('div');
                    valueEle.textContent = item.value;
                    valueEle.title = item.label;
                    row.appendChild(valueEle);
                });
            } else {
                const valueEle = document.createElement('div');
                valueEle.textContent = value;
                row.appendChild(valueEle);
            }
            return row;
        }
        const infoDictionary = {
            face: 'This is the name of the true type font.',
            size: 'The size of the true type font.',
            bold: 'The font is bold.',
            italic: 'The font is italic.',
            charset: 'The name of the OEM charset used (when not unicode).',
            unicode: 'Set to 1 if it is the unicode charset.',
            stretchH: 'The font height stretch in percentage. 100% means no stretch.',
            smooth: 'Set to 1 if smoothing was turned on.',
            aa: 'The supersampling level used. 1 means no supersampling was used.',
            padding: 'The padding for each character (up, right, down, left).',
            spacing: 'The spacing for each character (horizontal, vertical).',
            outline: 'The outline thickness for the characters.'
        };
        function updateInfo(data) {
            const infoElement = document.getElementById('info');
            const nameEle = addInfo('face', data.info.face, infoDictionary.face);
            infoElement.appendChild(nameEle);
            const sizeEle = addInfo('size', data.info.size, infoDictionary.size);
            infoElement.appendChild(sizeEle);
            const italicEle = addInfo('italic', data.info.italic, infoDictionary.italic);
            infoElement.appendChild(italicEle);
            const boldEle = addInfo('bold', data.info.bold, infoDictionary.bold);
            infoElement.appendChild(boldEle);
            const paddingEle = addInfo('padding', [
                { label: 'Top', value: data.info.padding[0] },
                { label: 'Right', value: data.info.padding[1] },
                { label: 'Bottom', value: data.info.padding[2] },
                { label: 'Left', value: data.info.padding[3] }
            ], infoDictionary.padding);
            infoElement.appendChild(paddingEle);
            const spacingEle = addInfo('spacing', [
                { label: 'Horizontal', value: data.info.spacing[0] },
                { label: 'Vertical', value: data.info.spacing[1] }
            ], infoDictionary.spacing);
            infoElement.appendChild(spacingEle);
            const stretchHEle = addInfo('stretchH', data.info.stretchH, infoDictionary.stretchH);
            infoElement.appendChild(stretchHEle);
            const unicodeEle = addInfo('unicode', data.info.unicode, infoDictionary.unicode);
            infoElement.appendChild(unicodeEle);
            const smoothEle = addInfo('smooth', data.info.smooth, infoDictionary.smooth);
            infoElement.appendChild(smoothEle);
            const aaEle = addInfo('aa', data.info.aa, infoDictionary.aa);
            infoElement.appendChild(aaEle);
            const outlineEle = addInfo('outline', data.info.outline, infoDictionary.outline);
            infoElement.appendChild(outlineEle);
        }
        const commonDictionary = {
            lineHeight: 'This is the distance in pixels between each line of text.',
            base: 'The number of pixels from the absolute top of the line to the base of the characters.',
            scaleW: 'The width of the texture, normally used to scale the x pos of the character image.',
            scaleH: 'The height of the texture, normally used to scale the y pos of the character image.',
            pages: 'The number of texture pages included in the font.',
            packed: 'Set to 1 if the monochrome characters have been packed into each of the texture channels. In this case alphaChnl describes what is stored in each channel.',
            alphaChnl: 'Set to 0 if the channel holds the glyph data, 1 if it holds the outline, 2 if it holds the glyph and the outline, 3 if its set to zero, and 4 if its set to one.',
            redChnl: 'Set to 0 if the channel holds the glyph data, 1 if it holds the outline, 2 if it holds the glyph and the outline, 3 if its set to zero, and 4 if its set to one.',
            greenChnl: 'Set to 0 if the channel holds the glyph data, 1 if it holds the outline, 2 if it holds the glyph and the outline, 3 if its set to zero, and 4 if its set to one.',
            blueChnl: 'Set to 0 if the channel holds the glyph data, 1 if it holds the outline, 2 if it holds the glyph and the outline, 3 if its set to zero, and 4 if its set to one.'
        };
        function updateCommon(data) {
            const commonElement = document.getElementById('common');
            Object.keys(commonDictionary).forEach(key => {
                const ele = addInfo(key, data.common[key], commonDictionary[key]);
                commonElement.appendChild(ele);
            });
        }
        function updateKernings(data) {
            const kerningsElement = document.getElementById('kernings');
            const ele = addInfo('Total Pairs', data.kernings.length, 'Total kerning pairs across all pages.');
            kerningsElement.appendChild(ele);
        }
        function drawCharacters(parentEle, chars) {
            chars.forEach(char => {
                const box = document.createElement('div');
                box.style.left = `${char.x * 2}px`;
                box.style.top = `${char.y * 2}px`;
                box.style.width = `${char.width * 2}px`;
                box.style.height = `${char.height * 2}px`;
                box.title = `id: ${char.id}`;
                parentEle.appendChild(box);
                characters.set(char.id, char);
            });
            console.log(`Parsed ${chars.length} characters`);
        }
        function whiteToTransparent(ctx, width, height) {
            for (let x = 0; x < width; x++) {
                for (let y = 0; y < height; y++) {
                    const color = ctx.getImageData(x, y, 1, 1).data;
                    const [r, g, b] = color;
                    if (r === 255 && g === 255 && b === 255) {
                        ctx.clearRect(x, y, 1, 1);
                    }
                }
            }
        }
        const ToastTheme = {
            info: 'info',
            warning: 'warning',
            error: 'error',
            success: 'success'
        }
        function toast(message, theme) {
            const toast = document.createElement('div');
            toast.classList.add('toast');
            toast.classList.add(`toast-${theme || ToastTheme.info}`);
            toast.textContent = message;
            document.querySelector('.main').appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        function renderChar(parent, previousCode, code) {
            const exists = kernings.has(`${previousCode}:${code}`);
            const amount = kernings.get(`${previousCode}:${code}`) || 0;
            const meta = characters.get(code);
            const ele = document.createElement('canvas');
            const ctx = ele.getContext('2d', { willReadFrequently: true });
            ele.width = meta.width;
            ele.height = meta.height;
            ele.style.width = `${meta.width}px`;
            ele.style.height = `${meta.height}px`;
            ctx.clearRect(0, 0, meta.width, meta.height);
            ctx.drawImage(
                imagePages.get(meta.page),
                meta.x, meta.y, meta.width, meta.height,
                0, 0, meta.width, meta.height
            );
            whiteToTransparent(ctx, meta.width, meta.height);
            // Default spacing
            let spaceHorizontal = info.get('spacing')[0];
            spaceHorizontal += amount;
            let spaceVertical = info.get('spacing')[1];
            ele.style.marginLeft = `${spaceHorizontal}px`;
            ele.title = `kerning: ${spaceHorizontal}; ${code} (${previousCode})`;
            ele.addEventListener('mouseenter', () => {
                ele.classList.add(exists ? 'hover-exists' : 'hover');
            });
            ele.addEventListener('mouseleave', () => {
                ele.classList.remove(exists ? 'hover-exists' : 'hover');
            });
            ele.addEventListener('click', () => {
                if (exists) {
                    toast('Kerning pair exists aleady!', ToastTheme.warning);
                } else if (previousCode === null) {
                    toast('Previous char required for kerning.', ToastTheme.warning);
                } else {
                    copyToClipboard(`,\n        {\n            "first": ${previousCode},\n            "second": ${code},\n            "amount": -1\n        }`);
                }
            });
            parent.appendChild(ele);
        }
        function updateText(preview, text) {
            // Clear preview
            while(preview.firstChild){
                preview.removeChild(preview.firstChild);
            }
            // Insert
            let previousCode = null;
            text.split('').forEach(char => {
                const code = char.charCodeAt(0);
                renderChar(preview, previousCode, code);
                previousCode = code;
            });
        }
        function validate() {
            const errors = [];
            // No duplicates
            
            // Output
            if (errors.length) {
                errors.forEach(error => {
                    console.log(error);
                });
                return;
            }
            console.log('Completed, no errors.')
        }
        function process(data) {
            Object.keys(data.info).forEach(key => {
                info.set(key, data.info[key]);
            });
            updateInfo(data);
            console.log(`Parsed info`);
            updateCommon(data);
            updateKernings(data);
            console.log(`Parsed common`);
            data.pages.forEach((page, pageIndex) => {
                pages.set(pageIndex, page);
                addPage(page);
                const parentEle = document.createElement('div');
                parentEle.classList.add('page');
                const img = document.createElement('img');
                img.addEventListener('load', (e) => {
                    e.target.style.width = `${e.target.offsetWidth * 2}px`;
                });
                img.src = page;
                parentEle.appendChild(img);
                drawCharacters(
                    parentEle,
                    data.chars.filter(char => char.page === pageIndex)
                );
                document.querySelector('.main').appendChild(parentEle);
                // Kerning Testing
                const preview = document.createElement('div');
                preview.classList.add('preview');
                const textarea = document.createElement('textarea');
                textarea.addEventListener('input', (e) => {
                    const { value } = e.target;
                    updateText(preview, value);
                });
                // Hover Info
                const hoverInfo = document.createElement('p');
                hoverInfo.appendChild(document.createTextNode('Hover to see char id, click to copy kerning'));
                document.querySelector('.main').appendChild(hoverInfo);
                // Textarea
                document.querySelector('.main').appendChild(textarea);
                // Preview
                document.querySelector('.main').appendChild(preview);
            });
            // Render Kerning Info
            const table = document.createElement('table');
            const thTr = document.createElement('tr');
            const th1 = document.createElement('th');
            th1.textContent = 'First';
            const th2 = document.createElement('th');
            th2.textContent = 'Second';
            const th3 = document.createElement('th');
            th3.textContent = 'Amount';
            const th4 = document.createElement('th');
            th4.textContent = 'Preview';
            thTr.appendChild(th1);
            thTr.appendChild(th2);
            thTr.appendChild(th3);
            thTr.appendChild(th4);
            table.appendChild(thTr);
            document.querySelector('.main').appendChild(table);
            data.kernings.forEach((kern, pageIndex) => {
                const { first, second, amount } = kern;
                kernings.set(`${first}:${second}`, amount);
                // Add to Chart
                const tdTr = document.createElement('tr');
                const td1 = document.createElement('td');
                td1.textContent = String.fromCharCode(first);
                const td2 = document.createElement('td');
                td2.textContent = String.fromCharCode(second);
                const td3 = document.createElement('td');
                td3.textContent = amount;
                const td4 = document.createElement('td');
                renderChar(td4, null, first);
                renderChar(td4, first, second);
                tdTr.appendChild(td1);
                tdTr.appendChild(td2);
                tdTr.appendChild(td3);
                tdTr.appendChild(td4);
                table.appendChild(tdTr);
            });
            console.log(`Parsed ${data.kernings.length} kerning pairs`);
            validate(data);
        }
        function copyToClipboard(text) {
            navigator.permissions.query({ name: "clipboard-write" }).then((result) => {
                if (result.state === "granted" || result.state === "prompt") {
                    navigator.clipboard.writeText(text).then(() => {
                        toast('Copied to clipboard!', ToastTheme.success);
                        console.log('Successfully wrote to clipboard');
                    }, () => {
                        console.error('Failed to write to clipboard');
                    });
                }
            });
        }
        window.addEventListener('load', () => {
            const file = 'jun_regular.json';
            console.log(`Loading '${file}'...`);
            fetch(file, {
                method: 'GET'
            }).then(async (response) => {
                const json = await response.json();
                // We need all the image data also cached...
                const promises = [];
                json.pages.forEach((page, pageIndex) => {
                    const img = new Image();
                    promises.push(new Promise(resolve => {
                        img.addEventListener('load', () => {
                            resolve(img);
                        }); 
                    }));
                    console.log(`Loading '${page}'...`);
                    img.src = page;
                    imagePages.set(pageIndex, img);
                });
                Promise.all(promises).then(() => {
                    console.log(`Begin processing...`);
                    process(json);
                });
            });
        });
    </script>
</head>
<body>
    <div class="tree">
        <ul>
            <li>
                <div>Pages</div>
                <ul id="pages" class="pages"></ul>
            </li>
            <li>
                <div>Font Info</div>
                <ul id="info" class="info"></ul>
            </li>
            <li>
                <div>Common</div>
                <ul id="common" class="common"></ul>
            </li>
            <li>
                <div>Kerning Pairs</div>
                <ul id="kernings" class="kernings"></ul>
            </li>
            <li class="version">
                Version 1.0
            </li>
        </ul>
    </div>
    <div class="main">
        
    </div>
</body>
</html>